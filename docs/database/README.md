# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

ã¨ã¡ã¾ã¡ï¼ˆæ ƒæœ¨çœŒãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆï¼‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã«é–¢ã™ã‚‹å®Œå…¨ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé›†ã§ã™ã€‚

## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ                               | èª¬æ˜                         | å¯¾è±¡èª­è€…         |
| ------------------------------------------ | ---------------------------- | ---------------- |
| [ER_DIAGRAM.md](./ER_DIAGRAM.md)           | å®Œå…¨ãªERå›³ã¨ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ä»•æ§˜ | é–‹ç™ºè€…ãƒ»DBç®¡ç†è€… |
| [SCHEMA_OVERVIEW.md](./SCHEMA_OVERVIEW.md) | ã‚¹ã‚­ãƒ¼ãƒæ¦‚è¦ã¨ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ | é–‹ç™ºè€…           |
| [SETUP_GUIDE.md](./SETUP_GUIDE.md)         | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é † | æ–°è¦é–‹ç™ºè€…       |

---

## ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«

- **B2B2Cãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **: 300ç¤¾é™å®šã®ç™»éŒ²æ¥­è€…ã¨ä¸€èˆ¬é¡§å®¢ã‚’ç¹‹ã
- **æœˆé¡èª²é‡‘**: æ¥­è€…ã‹ã‚‰12ä¸‡å††/æœˆã®å›ºå®šèª²é‡‘
- **å•ã„åˆã‚ã›æ©Ÿèƒ½**: ã‚«ãƒ¼ãƒˆå½¢å¼ã§è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã¾ã¨ã‚ã¦å•ã„åˆã‚ã›

### ä¸»è¦æ©Ÿèƒ½

1. æ¥­è€…ç™»éŒ²ãƒ»ç®¡ç†ï¼ˆ300ç¤¾é™å®šï¼‰
2. ã‚µãƒ¼ãƒ“ã‚¹ãƒ»æ–™é‡‘ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†
3. ã‚«ãƒ¼ãƒˆå¼å•ã„åˆã‚ã›ã‚·ã‚¹ãƒ†ãƒ 
4. æœˆé¡ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†
5. Instagramé€£æº

---

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹æˆ

### ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ•°

- **10ãƒ†ãƒ¼ãƒ–ãƒ«**: Users, Vendors, VendorProfiles, Categories, Services, Inquiries, InquiryItems, Subscriptions, InstagramAccounts, Admins
- **3ã¤ã®Enumå‹**: InquiryStatus, SubscriptionPlan, AdminRole

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ€è¡“

- **RDBMS**: PostgreSQL 14.x ä»¥ä¸Š
- **ORM**: Prisma 5.x
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: Prisma Migrate

---

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# PostgreSQL ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
brew services start postgresql@14  # macOS

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
cp .env.example .env
# .env ã‚’ç·¨é›†ã—ã¦ DATABASE_URL ã‚’è¨­å®š

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
npm run db:migrate

# åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
npm run db:seed
```

### 3. å‹•ä½œç¢ºèª

```bash
# Prisma Studioï¼ˆGUIï¼‰ã‚’èµ·å‹•
npm run db:studio
```

è©³ç´°ã¯ [SETUP_GUIDE.md](./SETUP_GUIDE.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«æ¦‚è¦

### ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«æ§‹é€                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Users (é¡§å®¢)                    Admins (ç®¡ç†è€…)            â”‚
â”‚    â†“ 1:N                                                    â”‚
â”‚  Inquiries (å•ã„åˆã‚ã›)                                      â”‚
â”‚    â†“ 1:N                                                    â”‚
â”‚  InquiryItems (æ˜ç´°)                                         â”‚
â”‚                                                             â”‚
â”‚  Categories (æ¥­ç¨®) â† N:1 â”€ Vendors (æ¥­è€… 300ç¤¾é™å®š)          â”‚
â”‚                              â†“ 1:1                          â”‚
â”‚                         VendorProfiles                      â”‚
â”‚                              â†“ 1:N                          â”‚
â”‚                         Services                            â”‚
â”‚                              â†“ 1:1                          â”‚
â”‚                         Subscriptions                       â”‚
â”‚                              â†“ 0..1:1                       â”‚
â”‚                         InstagramAccounts                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸»è¦ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- **1:1**: Vendor â†” VendorProfile, Vendor â†” Subscription
- **1:N**: Vendor â†’ Services, Vendor â†’ Inquiries, Inquiry â†’ InquiryItems
- **N:1**: Vendors â†’ Category

---

## ğŸ”‘ é‡è¦ãªè¨­è¨ˆåˆ¤æ–­

### 1. 300ç¤¾é™å®šã®å®Ÿè£…

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ¶ç´„ã§ã¯ãªãã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§åˆ¶å¾¡:

```typescript
const vendorCount = await prisma.vendor.count();
if (vendorCount >= 300) {
  throw new Error('ç™»éŒ²ä¸Šé™ã«é”ã—ã¦ã„ã¾ã™');
}
```

### 2. ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤æ™‚ã®ãƒ‡ãƒ¼ã‚¿ä¿æŒ

InquiryItems ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã€ã‚µãƒ¼ãƒ“ã‚¹åãƒ»æ–™é‡‘ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜:

```prisma
model InquiryItem {
  serviceId    String?  // NULLã«ãªã‚‹å¯èƒ½æ€§ã‚ã‚Š
  serviceName  String   // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
  servicePrice Decimal  // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
}
```

### 3. ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ

Inquiry ã® userId ã‚’ nullable ã«ã—ã€ã‚²ã‚¹ãƒˆæƒ…å ±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”¨æ„:

```prisma
model Inquiry {
  userId      String?  // nullable
  guestName   String?
  guestEmail  String?
  guestPhone  String?
}
```

### 4. æš—å·åŒ–ãŒå¿…è¦ãªãƒ‡ãƒ¼ã‚¿

Instagram accessToken ã¯æš—å·åŒ–ã—ã¦ä¿å­˜:

```typescript
// ä¿å­˜æ™‚
const encrypted = encrypt(accessToken);
await prisma.instagramAccount.create({
  data: { accessToken: encrypted },
});

// å–å¾—æ™‚
const decrypted = decrypt(account.accessToken);
```

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

| ãƒ†ãƒ¼ãƒ–ãƒ«  | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹             | ç”¨é€”                   |
| --------- | ------------------------ | ---------------------- |
| vendors   | `(approvedAt, isActive)` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¥­è€…ä¸€è¦§     |
| vendors   | `categoryId`             | ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¤œç´¢         |
| inquiries | `(vendorId, status)`     | æœªè¿”ä¿¡å•ã„åˆã‚ã›æ¤œç´¢   |
| services  | `(vendorId, isActive)`   | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ |

### ã‚¯ã‚¨ãƒªæœ€é©åŒ–

- **N+1å•é¡Œå¯¾ç­–**: Prisma ã® `include` ã‚’é©åˆ‡ã«ä½¿ç”¨
- **ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**: cursor-based pagination æ¨å¥¨
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ãªã©ã®é™çš„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### å®Ÿè£…å¿…é ˆé …ç›®

- [ ] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ bcrypt ã§ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆcost factor: 12ä»¥ä¸Šï¼‰
- [ ] Instagram ãƒˆãƒ¼ã‚¯ãƒ³ã¯ AES-256-CBC ã§æš—å·åŒ–
- [ ] SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼ˆPrisma ORM ä½¿ç”¨ã§è‡ªå‹•å¯¾å¿œï¼‰
- [ ] ç’°å¢ƒå¤‰æ•°ã«æ©Ÿå¯†æƒ…å ±ã‚’æ ¼ç´ï¼ˆ`.env` ã‚’ `.gitignore` ã«è¿½åŠ ï¼‰
- [ ] æœ¬ç•ªç’°å¢ƒã§ã¯ SSL/TLS æ¥ç¶šå¿…é ˆ

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

### Seed ãƒ‡ãƒ¼ã‚¿

åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆ`npm run db:seed`ï¼‰ã§ä»¥ä¸‹ãŒä½œæˆã•ã‚Œã¾ã™:

- **ã‚«ãƒ†ã‚´ãƒª**: 6ä»¶ï¼ˆå»ºè¨­æ¥­ã€é£²é£Ÿæ¥­ã€å°å£²æ¥­ã€å°‚é–€ã‚µãƒ¼ãƒ“ã‚¹ã€ç¾å®¹ãƒ»å¥åº·ã€æ•™è‚²ãƒ»ç¿’ã„äº‹ï¼‰
- **ç®¡ç†è€…**: 1ä»¶ï¼ˆ`admin@tochimachi.jp`ï¼‰
- **æ¥­è€…**: 3ç¤¾ï¼ˆå»ºè¨­ä¼šç¤¾ã€é¤ƒå­å±‹ã€ã„ã¡ã”è¾²åœ’ï¼‰
- **ã‚µãƒ¼ãƒ“ã‚¹**: 6ä»¶
- **ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³**: 3ä»¶
- **ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼**: 1ä»¶ï¼ˆ`test@example.com`ï¼‰

---

## ğŸ› ï¸ é–‹ç™ºãƒ„ãƒ¼ãƒ«

### Prisma Studio

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å¯è¦–åŒ–ãƒ»ç·¨é›†ãŒå¯èƒ½ãªGUIãƒ„ãƒ¼ãƒ«:

```bash
npm run db:studio
# http://localhost:5555 ã§èµ·å‹•
```

### VSCodeæ‹¡å¼µæ©Ÿèƒ½

æ¨å¥¨æ‹¡å¼µæ©Ÿèƒ½:

- **Prisma**: Prismaã‚¹ã‚­ãƒ¼ãƒã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒ»è£œå®Œ
- **PostgreSQL**: SQLã‚¯ã‚¨ãƒªå®Ÿè¡Œ

---

## ğŸ“ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

```bash
# ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´å¾Œ
npm run db:migrate -- --name add_new_feature

# ä¾‹: ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½è¿½åŠ 
npm run db:migrate -- --name add_reviews
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´

`prisma/migrations/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã¾ã™:

```
prisma/migrations/
â”œâ”€â”€ 20250102000000_init/
â”‚   â””â”€â”€ migration.sql
â”œâ”€â”€ 20250103000000_add_reviews/
â”‚   â””â”€â”€ migration.sql
â””â”€â”€ migration_lock.toml
```

---

## ğŸš€ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤

### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«æœ¬ç•ªç”¨ DATABASE_URL ã‚’è¨­å®š
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆç’°å¢ƒã§äº‹å‰æ¤œè¨¼
- [ ] æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—
- [ ] `npm run db:migrate:deploy` ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
- [ ] Prisma Client ã‚’å†ç”Ÿæˆ: `npm run db:generate`
- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:

```bash
pg_dump -U postgres tochimachi > backup_$(date +%Y%m%d).sql
```

---

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

### å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Prisma Documentation](https://www.prisma.io/docs)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- [Prisma Performance Tips](https://www.prisma.io/docs/guides/performance-and-optimization)
- [Database Design Patterns](https://wiki.postgresql.org/wiki/Don't_Do_This)

---

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®å¤‰æ›´ã‚’ææ¡ˆã™ã‚‹éš›ã¯:

1. `prisma/schema.prisma` ã‚’ç·¨é›†
2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ: `npm run db:migrate`
3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ï¼ˆERå›³ã€ã‚¹ã‚­ãƒ¼ãƒæ¦‚è¦ï¼‰
4. Pull Request ã‚’ä½œæˆ

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ:

1. [SETUP_GUIDE.md](./SETUP_GUIDE.md) ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ç¢ºèª
2. [GitHub Issues](https://github.com/ryoma3736/tochimachi/issues) ã§å ±å‘Š
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼ã«ç›¸è«‡

---

**ä½œæˆæ—¥**: 2025-12-02
**æœ€çµ‚æ›´æ–°**: 2025-12-02
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
**ãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼**: ã¨ã¡ã¾ã¡é–‹ç™ºãƒãƒ¼ãƒ 
